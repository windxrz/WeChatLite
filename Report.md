# 简易版“微信”实验报告
计55 2015011350 徐韧喆

### 1、实验目的
本实验要求我们使用socket编程技术完成一个简易版的“微信”，希望我们在掌握socket编程技术的基础上，深入了解TCP/IP网络应用程序的基本设计方法和实现技巧。

### 2、使用方法
本次实验我实现了命令行版的简易微信。运行服务器端和客户端后，可以进行以下操作：

 - 未登录用户
  - `search`，搜索所有用户
  - `login name password`，使用用户名和密码登录系统
  - `quit`，退出系统
 - 已登陆用户
  - `search`，搜索所有用户
  - `add name`，添加好友`name`
  - `ls`，显示已经添加的好友
  - `recvmsg`，接收未在聊天过程中收到的消息
  - `recvfile`，接收文件
  - `chat name`，与好友`name`进行聊天
  - `profile`，显示用户信息
  - `quit`，退出登录
 - 在聊天过程中
  - `exit`，退出聊天
  - `sendmsg`，发送消息
  - `sendfile`，发送文件

值得一提的是，在客户端中我使用了多线程的技术，支持实时接收数据。以上所有功能都已在现场演示的过程中展示成功。

### 3、实现过程
实现的方法主要从客户端和服务器端两部分进行讨论。

#### 客户端
客户端使用python实现，在和服务器通讯的过程中用python的socket库实现，连接成功后即可以进入事件循环，等待客户端的输入，直到遇到`quit`指令退出。另外为了方便，每次使用json格式的字符串和服务器端交互信息，这样可以方便处理。

在发送文件的实现过程中，我将一个文件拆成若干个部分，每次只发送1024个字节到服务器端，等到服务器端发送回确认收到的消息之后，再发送下一部分，这样可以保证发送内容的一致性，防止缓冲区中尚未来得及发送的内容被新加入的内容覆盖掉。

另外，在聊天的功能实现中，为了保证消息的实时接收，我使用了多线程的技术。即在聊天开始的时候额外开一个线程负责信息的接收。但是如上所述，在发送文件的时候也会收到服务器端的确认消息，因此在新开的线程中需要判断接收到的是聊天内容还是服务器端的确认收到消息。与此同时，我使用了python的multiprocessing库中的Queue模块，已实现多线程中不同线程的通讯。这样在新开线程中收到服务器端的确认收到消息之后，可以在主线程中继续发送下一部分文件。

#### 服务器端
按照要求，服务器端使用c++实现。为了和客户端使用json格式的内容通讯，我在github上找到了c++版的json库实现（地址见参考）。

在服务器端同样使用了多线程的办法，在主线程中不断等待下一个新的客户的连入。每当一个用户连入，边开一个线程来处理这个用户的各个操作。

当一个客户尝试发送文件时，如同上部分所述，每次接收到文件的一部分，就发送一个确认的消息回去，直到文件发送完成。当一个用户开始`recvfile`的时候，用同样的方式，将一个大文件拆分成一个一个小的部分发送，没发送一部分收到确认之后再发送下一部分，直到发送结束。


### 4、遇到的问题和解决方案
在本次实验中，最主要的问题就是文件收发的处理。在实现的过程中，发现服务器端发送回的确认收到消息会被客户端的新线程接收，因此陷入困境。不过后来在左浩佳同学的提醒下找到了multiprocessing的Queue模块，终于解决了困境。

另外我在实现的过程中，文件接收成功后一直无法打开，文件的大小和原来也是一样的，仔细检查才发现原来是接收内容的时候存储地址写错了。

### 5、总结
本次实验是计算机网络原理的大实验，在实现这个实验的过程中，我学习到了socket编程的方法，了解了发送消息以及发送文件等复杂功能的实现，还学习到了c++和python的多线程编程技术，可谓是收获很多。

### 参考
本次实现参考了陈齐斌同学的后端实现方法，服务器端参考了https://github.com/yorickdewid/Chat-Server 。另外我使用了 https://github.com/nlohmann/json/raw/develop/src/json.hpp
中json库。